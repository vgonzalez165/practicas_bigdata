```
------------- ESPECIALIZACIÓN EN INTELIGENCIA ARTIFICIAL Y BIG DATA -------------
---------------------------------------------------------------------------------

Módulo:                     BIG DATA APLICADO
Profesor:                   Víctor J. González
Unidad de Trabajo:          UT05. Procesamiento distribuido con PySpark
Práctica:                   PR0504B. Limpieza y normalización dataset turismo Castilla y León
Resultados de aprendizaje:  RA1
```

# PR0505. Limpieza de datos sobre dataset de lugares famosos


Vamos a trabajar con el dataset del portal de datos abiertos de Turismo de Castilla y León. El archivo contiene información sobre alojamientos, bares y restaurantes. Sin embargo, la calidad de los datos es deficiente: hay inconsistencias en mayúsculas/minúsculas, valores nulos, formatos de coordenadas mezclados y columnas redundantes.

Debes utilizar **PySpark** para ingestar, limpiar, normalizar y estructurar estos datos para su posterior análisis en un Dashboard.

## 2. Ingesta de datos

El fichero original es un **CSV** (o archivo de texto plano). Debes cargarlo en un `DataFrame` teniendo en cuenta:

* **Delimitador:** Punto y coma (`;`).
* **Cabecera:** La primera fila contiene los nombres de las columnas.
* **Codificación:** Asegúrate de que se lean correctamente los acentos (UTF-8 o ISO-8859-1 según corresponda).



## 3. Instrucciones de transformación por campo

A continuación se detallan las reglas de negocio que debes aplicar columna por columna. Debes aplicar estas transformaciones usando las funciones de `pyspark.sql.functions`.


### A. Identificación y categorización

| Campo original        | Transformación requerida |
| --------------------- | --- |
| **`establecimiento`** | Convertir a **Title Case** (primera letra mayúscula, resto minúscula). Eliminar espacios en blanco al inicio y final. |
| **`n_registro`**      | Clave primaria. Eliminar espacios. Si es nulo, eliminar la fila completa (integridad referencial). |
| **`tipo`**            | Limpieza de prefijos. Algunos valores vienen como "p - Actividades..." o "n - Oficinas...". Debes **eliminar los prefijos** "x - " para dejar solo la descripción limpia. |
| **`categoria`**       | Normalización. <br>1. Reemplazar "Categoría única" por "Unica".<br>2. Si contiene "Estrellas" o "Llaves", intentar extraer solo el número (ej: "2 Estrellas"  "2"). Mantener como String. |

### B. Datos del negocio

| Campo original                            | Transformación requerida |
| ----------------------------------------- | --- |
| **`nombre`**                              | Convertir a **Title Case**. Eliminar espacios dobles dentro del texto (ej: "Rio  Somiedo"  "Rio Somiedo"). |
| **`direccion`**                           | Convertir a **Title Case**. Intenta reemplazar abreviaturas comunes (ej: "C/" por "Calle", "Avda." por "Avenida"), si no, solo normalizar espacios y capitalización. |
| **`c_postal`**                            | Asegurar que sea un **String** de 5 caracteres. Si tiene menos de 5, rellenar con ceros a la izquierda . |
| **`provincia`, `municipio`, `localidad`** | Convertir a **Title Case**. Eliminar espacios. |
| **`nucleo`**                              | Si `nucleo` es nulo o vacío, rellenarlo con el valor de la columna `localidad`. |

### C. Contacto 

| Campo original               | Transformación requerida |
| ---------------------------- | --- |
| **`telefono_1`, `_2`, `_3`** | 1. Eliminar espacios internos (ej: "920 206"  "920206").<br>2. Crear una nueva columna llamada `telefonos_contacto` de tipo **Array** que contenga los teléfonos no nulos. <br>3. Eliminar las columnas originales `telefono_1`, `2` y `3`. |
| **`email`** | Convertir a **minúsculas**. Validar con una expresión regular simple si contiene un "@". Si no es válido, convertir a `null`. |
| **`web`** | Convertir a **minúsculas**. Comprobar si empieza por "http://" o "https://". Si no tiene protocolo y el campo no está vacío, añadir "https://" al principio. |

### D. Datos cuantitativos y Lógicos

| Campo original | Transformación requerida |
| --- | --- |
| **`plazas`** | Castear a tipo **Integer**. Los valores nulos deben ser convertidos a `0`. |
| **`accesible...`** | (Columna `accesible_a_personas_con_discapacidad`). Convertir a tipo **Boolean**. <br>Si el valor es "Si" (o variantes como "si"), asignar `True`.<br>Cualquier otro caso (incluido nulo), asignar `False`. |
| **`q_calidad`, `posada_real`, `especialidades`** | Rellenar valores nulos con el string "No aplica" o "Sin información". |

### E. Geolocalización

Hay tres columnas relacionadas: `gps_longitud`, `gps_latitud` y `posicion`.

A veces `gps_longitud` y `gps_latitud` están vacías, pero la información está en `posicion` (formato "lat, long"). A veces `posicion` está vacía pero las columnas individuales tienen datos.

1. **Limpieza:** asegurar que el separador decimal sea un punto (`.`) y no una coma.
2. **Relleno:**
   - Si `gps_latitud` es nula, intentar extraerla de la primera parte de la columna `posicion` (separando por la coma).
   - Si `gps_longitud` es nula, intentar extraerla de la segunda parte de la columna `posicion`.
3. **Casting:** convertir las columnas finales `latitud` y `longitud` a tipo **Double**.
4. **Eliminación:** eliminar la columna `posicion` y `column_27`  al finalizar.

## 4. Resultado esperado

El dataframe resultante debe cumplir con este esquema (aproximado):

```text
root
 |-- id_registro: string (nullable = true)
 |-- establecimiento: string (nullable = true)
 |-- categoria_normalizada: string (nullable = true)
 |-- nombre: string (nullable = true)
 |-- direccion_completa: struct (direccion, cp, municipio, provincia)
 |-- contacto: struct (telefonos (Array), email, web)
 |-- capacidad: integer (nullable = false)
 |-- es_accesible: boolean (nullable = false)
 |-- coordenadas: struct (latitud, longitud)

```