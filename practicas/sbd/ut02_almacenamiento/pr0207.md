```
------------- ESPECIALIZACIÓN EN INTELIGENCIA ARTIFICIAL Y BIG DATA -------------
---------------------------------------------------------------------------------

Módulo:                     SISTEMAS DE BIG DATA
Profesor:                   Víctor J. González
Unidad de Trabajo:          UT02. Almacenamiento de datos
Práctica:                   PR0207: Consultas con Flux
Resultados de aprendizaje:  RA3
```


# PR0207: Consultas con Flux

## Objetivo de la Práctica

En esta práctica utilizarás el lenguaje Flux para extraer, transformar y analizar datos de series temporales. Se utilizarán las funciones de *pipeline*, filtrado, agregación por ventanas (`aggregateWindow`) y manipulación de datos.


## PARTE I: Consultas de filtrado y estructura

El objetivo es familiarizarse con el inicio de la *pipeline* y el uso de Tags para filtrar.

### Tarea 1.1: Precio de cierre de Bitcoin

Escribe una consulta en Flux que:

1.  Use el bucket **`crypto_raw`**.
2.  Consulte los datos de de diciembre de 2020 (`range`).
3.  Filtre solo el activo **`BTC`** (usando el Tag `symbol`).
4.  Filtre solo el campo **`close`** (usando el Field `_field`).

### Tarea 1.2: Volumen Total del Ethereum (ETHUSDT)

Escribe una consulta que:

1.  Filtre los datos de **`ETH`** de **enero a junio de 2021**.
2.  Filtre el campo **`volume`**.
3.  Use la función de agregación **`sum()`** para calcular el volumen total de transacciones en ese periodo.


### PARTE II: Agregación temporal

Aquí se introduce el concepto clave de las series de tiempo: la agregación por ventanas de tiempo.

### Tarea 2.1: Precio promedio mensual

Escribe una consulta que:

1.  Filtre los precios de cierre (`close`) de **`BTC`** de **todo el histórico** disponible.
2.  Use la función **`aggregateWindow()`** para calcular el **precio promedio (`fn: mean`)** por **mes (`every: 1mo`)**.
3.  *Resultado esperado:* Una fila por mes, mostrando la media del precio de cierre de BTC en ese mes.

#### Tarea 2.2: Rango de volatilidad

Calcula el precio máximo y mínimo por semana para la criptomoneda **`Stellar`**.

1.  Filtra los precios de cierre de **`XLM`** del **año 2019**.
2.  Usa `aggregateWindow()` dos veces (o una vez con dos funciones):
    - Una *pipeline* para calcular el **máximo semanal** (`fn: max`, `every: 1wk`).
    - Una *pipeline* para calcular el **mínimo semanal** (`fn: min`, `every: 1wk`).
3.  Usa `yield()` para emitir ambos resultados.


## PARTE III: Manipulación y Joins

Estas tareas requieren transformar los datos o combinar información de diferentes series de tiempo.

### Tarea 3.1: Cálculo de variación porcentual diaria (Map)

Escribe una consulta que:

1.  Filtre los precios de cierre (`close`) de **Tether ()`USDT`)** de los **años 2016 a 2018**.
2.  Usa la función **`difference()`** para obtener la diferencia absoluta (en dólares) entre los precios de cierre diarios.
3.  Usa la función **`map()`** para transformar el resultado anterior y calcular la **variación porcentual diaria** (Diferencia / Precio del día anterior).

### Tarea 3.2: Comparación de precios de cierre (Join)

El objetivo es unir los precios de dos activos en una misma tabla para su comparación.

1.  Crea dos *pipelines* separadas para los precios de cierre (`close`):
    - `btc_data` para **`BTC`**.
    - `eth_data` para **`ETH`**.
    - Ambas deben usar el mismo rango de tiempo (ej. **año 2020**).
2.  Usa la función **`join()`** para combinar ambas tablas por la marca de tiempo (`on: ["_time"]`).
3.  Usa la función **`map()`** para calcular una nueva columna llamada **`ratio`** que sea el resultado de dividir el precio de BTC entre el precio de ETH (`r.btc_data._value / r.eth_data._value`).

## Entrega

Debes entregar un Markdown con el código Flux y una captura de la visualización del resultado pedido.