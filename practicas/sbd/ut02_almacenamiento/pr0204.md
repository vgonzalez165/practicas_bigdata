```
------------- ESPECIALIZACIÓN EN INTELIGENCIA ARTIFICIAL Y BIG DATA -------------
---------------------------------------------------------------------------------

Módulo:                     SISTEMAS DE BIG DATA
Profesor:                   Víctor J. González
Unidad de Trabajo:          UT02. Almacenamiento de datos
Práctica:                   PR0204: Escritura de datos en InfluxDB
Resultados de aprendizaje:  RA3
```


## Práctica: Monitorización de rendimiento del servidor con Python 

### Objetivo de la Práctica

En esta práctica aplicaremos los conocimientos de conexión, modelado de datos (`Point`) y escritura eficiente en lote (Batching) para crear un agente de monitorización que envíe métricas de un sistema operativo a InfluxDB.


### PARTE I: Obtención de métricas

Para esta práctica, utilizaremos la librería **`psutil`** para obtener las métricas de rendimiento de la máquina en la que se ejecuta el script.

El siguiente código muestra cómo obtener los porcentajes de uso de CPU y RAM, así como el total de RAM utilizada:

```python
import psutil
import time

# Obtener estadísticas de uso
def obtener_metricas_sistema(host_id):
    # Uso de CPU (promedio de los últimos segundos)
    cpu_usage = psutil.cpu_percent(interval=1)
    
    # Uso de RAM
    mem = psutil.virtual_memory()
    ram_used_gb = round(mem.used / (1024**3), 2) # Conversión a GB
    ram_percent = mem.percent
    
    # Uso de disco (en el punto de montaje raíz)
    disk = psutil.disk_usage('/')
    disk_percent = disk.percent
    
    return {
        'host': host_id,
        'cpu_percent': cpu_usage,
        'ram_used_gb': ram_used_gb,
        'ram_percent': ram_percent,
        'disk_percent': disk_percent
    }

# Ejemplo de uso:
# metrics = obtener_metricas_sistema("servidor_01")
# print(metrics)
```

### PARTE II: Modelado y escritura en lote

#### 1\. Diseño del modelo InfluxDB

El modelo debe asegurar que las métricas sean fáciles de consultar por máquina (host).

| Componente       | Clave                  | Valor de Ejemplo | Tipo en InfluxDB  |
| :--------------- | :--------------------- | :--------------- | :---------------- |
| **Measurement**  | `rendimiento_servidor` | Fijo             | Fijo              |
| **TAG**          | `host_id`              | `servidor_01`    | String (Indexado) |
| **TAG**          | `entorno`              | `produccion`     | String (Indexado) |
| **FIELD**        | `cpu_percent`          | `45.8`           | Float (Medición)  |
| **FIELD**        | `ram_percent`          | `82.1`           | Float (Medición)  |
| **FIELD**        | `disk_percent`         | `65.4`           | Float (Medición)  |

#### 2\. Tareas de Implementación

Desarrolla el script Python principal (`agente_monitoreo.py`) para:

1.  **Inicialización:** configurar el cliente y la `WriteAPI` en **modo Batching** (asíncrono) para optimizar el rendimiento.
2.  **Bucle de lectura:** crear un bucle infinito que:
    a. Llame a `obtener_metricas_sistema("servidor_A")` **cada segundo**.
    b. Construya un nuevo objeto `Point` por cada lectura, respetando el modelo de datos anterior.
    c. Use la `write_api.write()` para enviar el punto al buffer.
3.  **Cierre:** Asegurarse de que el script llama a `write_api.close()` antes de salir (p.ej., en una [excepción de teclado](https://www.geeksforgeeks.org/python/how-to-catch-a-keyboardinterrupt-in-python/)) para vaciar cualquier punto que quede en el buffer.
